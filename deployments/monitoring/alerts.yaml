# Prometheus Alert Rules for Schema Registry
# These rules define 25+ production-grade alerts with runbook links

groups:
  - name: schema_registry_slo_violations
    interval: 30s
    rules:
      # Critical SLO Violations
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(schema_registry_http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(schema_registry_http_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          component: api
          slo: error_rate
        annotations:
          summary: "Error rate exceeds 5% for 5 minutes"
          description: "Error rate is {{ $value | humanizePercentage }}. SLO target is <1%."
          runbook: "https://runbooks.example.com/schema-registry/high-error-rate"
          dashboard: "https://grafana.example.com/d/slo-dashboard"

      - alert: HighLatencyP95
        expr: |
          histogram_quantile(0.95,
            sum(rate(schema_registry_http_request_duration_seconds_bucket[5m])) by (le)
          ) > 0.010
        for: 10m
        labels:
          severity: warning
          component: api
          slo: latency
        annotations:
          summary: "p95 latency exceeds 10ms for 10 minutes"
          description: "p95 latency is {{ $value | humanizeDuration }}. SLO target is <10ms."
          runbook: "https://runbooks.example.com/schema-registry/high-latency"
          dashboard: "https://grafana.example.com/d/red-dashboard"

      - alert: LowAvailability
        expr: |
          (
            sum(rate(schema_registry_http_requests_total{status=~"2.."}[30m]))
            /
            sum(rate(schema_registry_http_requests_total[30m]))
          ) < 0.999
        for: 5m
        labels:
          severity: critical
          component: api
          slo: availability
        annotations:
          summary: "Availability drops below 99.9%"
          description: "Availability is {{ $value | humanizePercentage }}. SLO target is >99.9%."
          runbook: "https://runbooks.example.com/schema-registry/low-availability"
          dashboard: "https://grafana.example.com/d/slo-dashboard"

      # Error Budget Alerts
      - alert: FastErrorBudgetBurn
        expr: |
          (
            sum(rate(schema_registry_http_requests_total{status=~"5.."}[1h]))
            /
            sum(rate(schema_registry_http_requests_total[1h]))
          ) / 0.001 > 14.4
        for: 2m
        labels:
          severity: critical
          component: api
          slo: error_budget
        annotations:
          summary: "Error budget burning at 14.4x rate (entire budget in 2h)"
          description: "Current burn rate: {{ $value }}x. This will exhaust the error budget in ~2 hours."
          runbook: "https://runbooks.example.com/schema-registry/error-budget-burn"
          dashboard: "https://grafana.example.com/d/slo-dashboard"

      - alert: SlowErrorBudgetBurn
        expr: |
          (
            sum(rate(schema_registry_http_requests_total{status=~"5.."}[6h]))
            /
            sum(rate(schema_registry_http_requests_total[6h]))
          ) / 0.001 > 6
        for: 15m
        labels:
          severity: warning
          component: api
          slo: error_budget
        annotations:
          summary: "Error budget burning at 6x rate (entire budget in 5h)"
          description: "Current burn rate: {{ $value }}x. This will exhaust the error budget in ~5 hours."
          runbook: "https://runbooks.example.com/schema-registry/error-budget-burn"
          dashboard: "https://grafana.example.com/d/slo-dashboard"

  - name: schema_registry_resource_saturation
    interval: 30s
    rules:
      # Database Connection Pool
      - alert: DatabasePoolExhausted
        expr: |
          schema_registry_db_connections_active{pool="postgres"}
          /
          schema_registry_db_connections_max{pool="postgres"}
          > 0.9
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database connection pool >90% utilized"
          description: "Connection pool utilization: {{ $value | humanizePercentage }}"
          runbook: "https://runbooks.example.com/schema-registry/db-pool-exhausted"

      - alert: DatabasePoolCritical
        expr: |
          schema_registry_db_connections_active{pool="postgres"}
          /
          schema_registry_db_connections_max{pool="postgres"}
          > 0.95
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection pool >95% utilized (CRITICAL)"
          description: "Connection pool utilization: {{ $value | humanizePercentage }}. Immediate action required."
          runbook: "https://runbooks.example.com/schema-registry/db-pool-critical"

      # Memory Saturation
      - alert: HighMemoryUsage
        expr: |
          schema_registry_process_memory_bytes{type="rss"} > 4294967296
        for: 10m
        labels:
          severity: warning
          component: system
        annotations:
          summary: "Memory usage exceeds 4GB"
          description: "Memory usage: {{ $value | humanize1024 }}"
          runbook: "https://runbooks.example.com/schema-registry/high-memory"

      # Cache Performance
      - alert: LowCacheHitRate
        expr: |
          schema_registry_cache_hit_rate{tier="L1"} < 0.70
        for: 15m
        labels:
          severity: warning
          component: cache
        annotations:
          summary: "L1 cache hit rate below 70%"
          description: "Cache hit rate: {{ $value | humanizePercentage }}. Target is >95%."
          runbook: "https://runbooks.example.com/schema-registry/low-cache-hit-rate"

      - alert: CriticalCacheHitRate
        expr: |
          schema_registry_cache_hit_rate{tier="L1"} < 0.50
        for: 5m
        labels:
          severity: critical
          component: cache
        annotations:
          summary: "L1 cache hit rate below 50% (CRITICAL)"
          description: "Cache hit rate: {{ $value | humanizePercentage }}. Severe performance degradation expected."
          runbook: "https://runbooks.example.com/schema-registry/critical-cache-hit-rate"

  - name: schema_registry_database_issues
    interval: 30s
    rules:
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(schema_registry_db_query_duration_seconds_bucket[5m])) by (le, query)
          ) > 0.050
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "p95 database query duration >50ms"
          description: "Query: {{ $labels.query }}. Duration: {{ $value | humanizeDuration }}"
          runbook: "https://runbooks.example.com/schema-registry/slow-queries"

      - alert: DatabaseConnectionErrors
        expr: |
          rate(schema_registry_db_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection errors detected"
          description: "Error rate: {{ $value }} errors/sec"
          runbook: "https://runbooks.example.com/schema-registry/db-connection-errors"

      - alert: DatabasePoolWaitTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(schema_registry_db_pool_wait_duration_seconds_bucket[5m])) by (le)
          ) > 0.100
        for: 5m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "High database pool wait time (p95 >100ms)"
          description: "Wait time: {{ $value | humanizeDuration }}"
          runbook: "https://runbooks.example.com/schema-registry/db-pool-wait"

  - name: schema_registry_redis_issues
    interval: 30s
    rules:
      - alert: RedisConnectionErrors
        expr: |
          rate(schema_registry_redis_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: critical
          component: redis
        annotations:
          summary: "Redis connection errors detected"
          description: "Error rate: {{ $value }} errors/sec"
          runbook: "https://runbooks.example.com/schema-registry/redis-errors"

      - alert: SlowRedisOperations
        expr: |
          histogram_quantile(0.95,
            sum(rate(schema_registry_redis_operation_duration_seconds_bucket[5m])) by (le, command)
          ) > 0.010
        for: 10m
        labels:
          severity: warning
          component: redis
        annotations:
          summary: "Slow Redis operations detected (p95 >10ms)"
          description: "Command: {{ $labels.command }}. Duration: {{ $value | humanizeDuration }}"
          runbook: "https://runbooks.example.com/schema-registry/slow-redis"

  - name: schema_registry_s3_issues
    interval: 30s
    rules:
      - alert: S3Errors
        expr: |
          rate(schema_registry_s3_errors_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: s3
        annotations:
          summary: "S3 errors detected"
          description: "Error rate: {{ $value }} errors/sec"
          runbook: "https://runbooks.example.com/schema-registry/s3-errors"

      - alert: SlowS3Operations
        expr: |
          histogram_quantile(0.95,
            sum(rate(schema_registry_s3_operation_duration_seconds_bucket[5m])) by (le, operation)
          ) > 5.0
        for: 10m
        labels:
          severity: warning
          component: s3
        annotations:
          summary: "Slow S3 operations (p95 >5s)"
          description: "Operation: {{ $labels.operation }}. Duration: {{ $value | humanizeDuration }}"
          runbook: "https://runbooks.example.com/schema-registry/slow-s3"

  - name: schema_registry_business_metrics
    interval: 1m
    rules:
      - alert: ValidationFailureSpike
        expr: |
          (
            sum(rate(schema_registry_validations_total{result="failure"}[5m]))
            /
            sum(rate(schema_registry_validations_total[5m]))
          ) > 0.10
        for: 10m
        labels:
          severity: warning
          component: validation
        annotations:
          summary: "Validation failure rate >10%"
          description: "Failure rate: {{ $value | humanizePercentage }}"
          runbook: "https://runbooks.example.com/schema-registry/validation-failures"

      - alert: CompatibilityCheckFailures
        expr: |
          (
            sum(rate(schema_registry_compatibility_checks_total{result="incompatible"}[5m]))
            /
            sum(rate(schema_registry_compatibility_checks_total[5m]))
          ) > 0.20
        for: 10m
        labels:
          severity: info
          component: compatibility
        annotations:
          summary: "High rate of compatibility failures (>20%)"
          description: "Incompatibility rate: {{ $value | humanizePercentage }}"
          runbook: "https://runbooks.example.com/schema-registry/compatibility-failures"

  - name: schema_registry_security
    interval: 30s
    rules:
      - alert: HighAuthenticationFailureRate
        expr: |
          rate(schema_registry_http_requests_total{status="401"}[5m]) > 1
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "High authentication failure rate"
          description: "Failure rate: {{ $value }} req/sec. Possible brute force attack."
          runbook: "https://runbooks.example.com/schema-registry/auth-failures"

      - alert: RateLimitHit
        expr: |
          rate(schema_registry_http_requests_total{status="429"}[5m]) > 10
        for: 5m
        labels:
          severity: info
          component: security
        annotations:
          summary: "Rate limits being hit frequently"
          description: "Rate limit hits: {{ $value }} req/sec"
          runbook: "https://runbooks.example.com/schema-registry/rate-limits"

  - name: schema_registry_health
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: up{job="schema-registry"} == 0
        for: 1m
        labels:
          severity: critical
          component: health
        annotations:
          summary: "Schema Registry service is down"
          description: "Service has been down for >1 minute"
          runbook: "https://runbooks.example.com/schema-registry/service-down"

      - alert: HealthCheckFailing
        expr: |
          rate(schema_registry_http_requests_total{path="/health", status!="200"}[5m]) > 0
        for: 2m
        labels:
          severity: critical
          component: health
        annotations:
          summary: "Health check endpoint failing"
          description: "Health checks have been failing for >2 minutes"
          runbook: "https://runbooks.example.com/schema-registry/health-check-failing"

      - alert: HighRequestLatencySpike
        expr: |
          (
            histogram_quantile(0.95,
              sum(rate(schema_registry_http_request_duration_seconds_bucket[5m])) by (le)
            )
            /
            histogram_quantile(0.95,
              sum(rate(schema_registry_http_request_duration_seconds_bucket[1h])) by (le)
            )
          ) > 2
        for: 5m
        labels:
          severity: warning
          component: performance
        annotations:
          summary: "Request latency spike detected (2x increase)"
          description: "Current p95 latency is 2x higher than 1h average"
          runbook: "https://runbooks.example.com/schema-registry/latency-spike"
